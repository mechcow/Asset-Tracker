# Autogenerated puppet file, generated by Asset-Tracker
#
# $HeadURL: http://svn.syd.int.threatmetrix.com/svn/tm/trunk/ops/asset_tracker/app/views/assets/index.puppet.erb $
# $Id: index.puppet.erb 27710 2011-02-16 11:50:38Z smelwani $
# Generated at : <%= Time.new.inspect %>

# all guests

import "xen_dom_0"

<% @guest_assets.each do|guest| -%>
<%   rolename = guest.named_role -%>
<%   if guest.main_ip.nil? -%>
# ERROR: missing interface for <%= guest.shortname %>
# Can't output xen_guest config or node config
<%   elsif guest.parent.main_ip.nil? -%>
# ERROR: missing parent interface for <%= guest.shortname %>, necessary for gateway
# Can't output xen_guest config or not config
# Add interface to <%= guest.parent.shortname %>
<%   else -%>
  @xen_guest { "<%= guest.shortname %>": 
      role            => "<%= rolename %>",
      guest_memory    => "<%= guest.ram %>",
      vcpus           => "<%= guest.vcpus %>",
      dom0            => "<%= guest.parent.shortname %>",
      guest_ip        => "<%= guest.main_ip %>",
      guest_gateway   => "<%= guest.parent.main_if.gateway %>",
      guest_interface => "eth0",
      guest_netmask   => "<%= guest.main_if.netmask %>",
      dom0_ip         => "<%= guest.parent.main_ip %>",
      dom0_fqdn       => "<%= guest.parent.fqdn %>",
      number          => "<%= guest.number %>",
      env             => "<%= guest.env %>",
      timezone        => "<%= guest.location.timezone %>",
      cluster         => "<%= guest.cluster %>",
      domain          => "<%= guest.domain %>",
      vgname          => "<%= guest.parent.vgname %>",
      swap            => "<%= guest.swap %>",
      location        => "<%= guest.location.name.downcase %>",
      dns             => "<%= guest.location.dns %>",
      puppetmaster_ip => "<%= guest.location.puppetmaster_ip %>",
      centos_ip       => "<%= guest.location.centos_ip %>",
      vifs            => "<%= guest.location.vifs %>",
  }

  node "<%=  guest.fqdn %>" {
      $vgname = "<%= guest.shortname.gsub("-","") %>"
      $local_ip = "<%= guest.main_ip %>"<% if guest.respond_to? :vpn_if %>
      $local_ip_vpn = "<%= guest.vpn_ip %>"<% end %>
      $ha_ping_ip = "<%= guest.parent.main_ip %>"<% if !guest.parent_puppet_class.nil? %>
      $role = "<%= rolename %>"

<%       guest.roles.each do |role| -%>
      $<%= role.name -%>_role = "1"
<%       end -%>
<%       guest.interfaces.each do |interface| %>
      network-interface { "<%= interface.name %>":
          onboot  => "yes",
          ipaddr  => "<%= interface.ipaddr %>",
          netmask => "<%= interface.netmask %>",<% if !interface.gateway.blank? %>
          gateway => "<%= interface.gateway %>",<% end %><% if !interface.mac.blank? %>
          mac => "<%= interface.mac %>"<% end %>
      }
<%       end -%>

      include <%= guest.parent_puppet_class %><% end %>
  }

<%   end -%>
<% end -%>

# dom0s

<% 
$BASE_LOGSIZE = 10

def calc_logsize(guest)
  logsize = $BASE_LOGSIZE
  guest.roles.find_all { |role| role.extra_log_size? }.each { |role| logsize = logsize + role.extra_log_size }
  logsize
end
-%>

<% @physical_assets.each do |asset| -%>
  node "<%= asset.shortname %>" {
      $vgname = "<%= asset.vgname %>"
      include <%= asset.location.name.downcase %>-dom0

      Xen_guest <| dom0=="<%= asset.shortname %>" |>

      # xen_guest_disks
<% asset.guests.each do |guest| %>
      log_disk { "<%= guest.shortname %>":
          vg   => "<%= asset.vgname %>",
          size => "<%= calc_logsize(guest) %>",
      }
      swap_disk { "<%= guest.shortname %>":
          vg   => "<%= asset.vgname %>",
          size => "<%= guest.swap/1024.0 %>",
      }
<%   guest.roles.each do |role| -%>
      <%= role.name %>_disks { "<%= guest.shortname %>":
<%     if role.name =~ /base/ -%>
          size   => "<%= guest.disk_space/1024.0 %>", 
<%     end -%>
          mainvg => "<%= asset.vgname %>",
          logsvg => "<%= asset.vgname %>",
          datavg => "<%= asset.vgname %>",
          location => "<%= asset.location.name.downcase %>",
      }
<%   end %>
<% end %>

<%   asset.interfaces.each do |interface| -%>
<%     if interface.master -%>
      slave-interface { "<%= interface.name %>":
          onboot  => "yes",
          master  => "<%= interface.master.name %>",
      }
<%     else -%>
      network-interface { "<%= interface.name %>":
          onboot  => "yes",
          ipaddr  => "<%= interface.ipaddr %>",
          netmask => "<%= interface.netmask %>",<% if !interface.gateway.blank? %>
          gateway => "<%= interface.gateway %>",<% end %><% if !interface.mac.blank? %>
          mac => "<%= interface.mac %>"<% end %>
      }
<%     end -%>
<%   end -%>
  }

<% end -%>

